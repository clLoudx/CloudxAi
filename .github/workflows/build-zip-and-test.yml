name: Build ZIP & Smoke Tests

on:
  workflow_dispatch:
  push:
    tags: [ 'v*', 'release-*' ]

permissions:
  contents: read
  artifacts: write

jobs:
  build-zip:
    name: Build ZIP artifact
    runs-on: ubuntu-latest
    outputs:
      artifact-path: ${{ steps.upload-art.outputs.artifact-path || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure builder script executable
        run: chmod +x build_release_zip.sh || true

      - name: Run build_release_zip.sh
        run: |
          ./build_release_zip.sh
        env:
          CI: true

      - name: Upload artifact
        id: upload-art
        uses: actions/upload-artifact@v4
        with:
          name: aiagent-release-zip
          path: ./dist/*.zip

  smoke-tests:
    name: Run smoke tests (local)
    needs: build-zip
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: aiagent-release-zip
          path: ./artifact

      - name: Extract and run minimal smoke tests
        run: |
          ls -la artifact || true
          # optionally unzip and run local smoke scripts present in archive
          unzip -q artifact/*.zip -d /tmp/aiagent_release || true
          # run import checks from repo root
          chmod +x smoke_tests/ci_wrapper.sh
          ./smoke_tests/ci_wrapper.sh local

