name: Auto-merge PRs (opt-in)

# Auto-merge workflow
# - Triggers when a PR is marked Ready for review
# - Requires the label `auto-merge` to opt-in
# - Rejects PRs from forks for safety
# - Runs a fast smoke test before merging

on:
  pull_request:
    types: [ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check prerequisites
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            if (!pr) return { should_run: 'false', reason: 'no_pr' }
            if (pr.draft) return { should_run: 'false', reason: 'is_draft' }
            const labels = pr.labels.map(l => l.name)
            if (!labels.includes('auto-merge')) return { should_run: 'false', reason: 'missing_label' }
            if (pr.head.repo.full_name !== `${context.repo.owner}/${context.repo.repo}`) return { should_run: 'false', reason: 'cross_repo' }
            return { should_run: 'true' }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  preflight:
    name: Run preflight checks (lint & tests)
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_run == 'true'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run optional linters
        run: |
          if command -v ruff >/dev/null 2>&1; then ruff check . || true; fi

      - name: Run tests (fast smoke)
        id: tests
        run: |
          export PYTHONPATH=.
          if [ -f step_runner/tests/test_runner.py ]; then
            pytest -q step_runner/tests/test_runner.py
          else
            pytest -q || true
          fi

  merge:
    name: Merge when checks pass
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.validate.outputs.should_run == 'true' && needs.preflight.result == 'success'
    steps:
      - name: Merge PR via API
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            const owner = context.repo.owner
            const repo = context.repo.repo
            const number = pr.number
            const { data: updated } = await github.rest.pulls.get({ owner, repo, pull_number: number })
            if (updated.draft) throw new Error('PR is still draft')
            const res = await github.rest.pulls.merge({ owner, repo, pull_number: number, merge_method: 'squash' })
            core.info('Merge response: ' + JSON.stringify(res.data))
            if (!res.data.merged) throw new Error('Merge failed: ' + JSON.stringify(res.data))
            return res.data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
