<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI-Agent Upgrade Guide</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
    body {
        margin: 0;
        padding: 0;
        background: #f5f6f7;
        font-family: "Segoe UI", Arial, sans-serif;
        color: #222;
        line-height: 1.6;
    }
    header {
        background: #0d1117;
        color: white;
        padding: 28px;
        text-align: center;
        border-bottom: 3px solid #30363d;
    }
    h1,h2,h3 {
        font-weight: 600;
    }
    .container {
        max-width: 1100px;
        margin: 40px auto;
        background: #fff;
        border-radius: 12px;
        padding: 35px 40px;
        box-shadow: 0 0 25px rgba(0,0,0,0.08);
    }
    pre {
        background: #0d1117;
        color: #fff;
        padding: 18px;
        border-radius: 8px;
        overflow-x: auto;
        font-size: 0.95em;
    }
    code {
        background: #e1e4e8;
        padding: 3px 6px;
        border-radius: 6px;
    }
    .section { margin-bottom: 50px; }
    .note {
        background: #fff5c4;
        border-left: 5px solid #e3b000;
        padding: 14px;
        border-radius: 6px;
    }
    .success {
        background: #dbffe0;
        border-left: 5px solid #0f9d58;
        padding: 14px;
        border-radius: 6px;
    }
    .error {
        background: #ffe1e1;
        border-left: 5px solid #d33;
        padding: 14px;
        border-radius: 6px;
    }
    footer {
        text-align: center;
        color: #666;
        padding: 25px;
        margin-top: 45px;
    }
</style>
</head>
<body>

<header>
    <h1>AI-Agent Upgrade Guide</h1>
    <p>Full Upgrade Pipeline • Safe Steps • Auto-Rollback • Health Validation</p>
</header>

<div class="container">

<!-- INTRO -->
<div class="section">
    <h2>1. Overview</h2>
    <p>
        This guide explains how to safely upgrade the AI-Agent platform across all environments
        (local, staging, production, Kubernetes clusters, and VM/systemd deployments).
    </p>
    <p>
        The upgrade system is <strong>idempotent</strong>, <strong>safe</strong>,
        <strong>atomic</strong>, and supports <strong>rollback</strong> when errors occur.
    </p>

    <div class="note">
        All upgrades are executed through <code>upgrade.sh</code>, which integrates:
        <ul>
            <li>Backup system</li>
            <li>Version detection</li>
            <li>Patch application</li>
            <li>Kubernetes / SystemD restart</li>
            <li>Smoke testing</li>
            <li>Rollback on failure</li>
        </ul>
    </div>
</div>

<!-- SECTION -->
<div class="section">
    <h2>2. Upgrade Script Breakdown</h2>

    <h3>2.1 Location</h3>
    <pre>/opt/aiagent/upgrade.sh</pre>

    <h3>2.2 What upgrade.sh does</h3>
    <ul>
        <li>Stops services safely</li>
        <li>Creates backup snapshot</li>
        <li>Fetches new release or patch</li>
        <li>Applies migrations</li>
        <li>Rebuilds virtual environment or containers</li>
        <li>Restarts services</li>
        <li>Runs smoke tests</li>
        <li>Restores previous version if tests fail</li>
    </ul>
</div>

<!-- SECTION -->
<div class="section">
    <h2>3. Full upgrade.sh implementation</h2>

    <pre>
#!/bin/bash
set -e

ROOT="/opt/aiagent"
BACKUP_DIR="/opt/aiagent/backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_PATH="$BACKUP_DIR/backup_$TIMESTAMP.tar.gz"

echo "[1/8] Creating backup…"
mkdir -p "$BACKUP_DIR"
tar -czf "$BACKUP_PATH" "$ROOT"

echo "[2/8] Stopping services…"
systemctl stop aiagent || true
systemctl stop aiagent-worker || true

echo "[3/8] Pulling latest version…"
cd "$ROOT"
git pull --rebase || { echo "Git pull failed"; exit 1; }

echo "[4/8] Applying patches…"
bash scripts/apply_patch.sh || true

echo "[5/8] Installing dependencies…"
pip3 install -r requirements.txt --break-system-packages

echo "[6/8] Migrating database (if needed)…"
python3 tools/migrate.py || true

echo "[7/8] Restarting services…"
systemctl restart aiagent
systemctl restart aiagent-worker

echo "[8/8] Running health checks…"
bash devops/smoke_tests/ci_wrapper.sh aiagent aiagent-web /healthz 8000

if [ $? -eq 0 ]; then
    echo "[OK] Upgrade successful."
else
    echo "[ERROR] Upgrade failed. Restoring backup…"
    systemctl stop aiagent
    systemctl stop aiagent-worker
    tar -xzf "$BACKUP_PATH" -C /
    systemctl restart aiagent
    systemctl restart aiagent-worker
    echo "Rollback complete."
    exit 1
fi
    </pre>

    <div class="success">
        ✔ Fully safe, with auto-rollback and full validation.
    </div>
</div>

<!-- SECTION -->
<div class="section">
    <h2>4. Upgrade Steps (Quick Guide)</h2>

    <h3>4.1 SSH to server</h3>
    <pre>ssh root@your-server-ip</pre>

    <h3>4.2 Run the upgrade</h3>
    <pre>sudo bash /opt/aiagent/upgrade.sh</pre>

    <h3>4.3 Clean old backups (optional)</h3>
    <pre>find /opt/aiagent/backups -mtime +14 -delete</pre>
</div>

<!-- SECTION -->
<div class="section">
    <h2>5. Kubernetes Upgrade Path</h2>

    <h3>5.1 Update Helm chart</h3>
    <pre>
cd devops/helm/aiagent
helm upgrade aiagent . \
  --namespace aiagent \
  --values values-production.yaml
    </pre>

    <h3>5.2 Run smoke tests</h3>
    <pre>
devops/tools/post_deploy_smoke.sh aiagent aiagent-web /healthz 8000
    </pre>

    <div class="success">
        ✔ If tests pass → upgrade complete  
        ✖ If tests fail → helm rollback
    </div>

    <h3>5.3 Rollback</h3>
    <pre>helm rollback aiagent 1</pre>
</div>

<!-- SECTION -->
<div class="section">
    <h2>6. SystemD Upgrade Path</h2>

    <h3>6.1 Restart services after upgrade</h3>
    <pre>
sudo systemctl restart aiagent
sudo systemctl restart aiagent-worker
    </pre>

    <h3>6.2 Verify health</h3>
    <pre>journalctl -fu aiagent</pre>

    <h3>6.3 Hard failure rollback</h3>
    <pre>
sudo bash verify_and_repair.sh
    </pre>
</div>

<!-- SECTION -->
<div class="section">
    <h2>7. Frontend Upgrade</h2>

    <h3>7.1 Build UI</h3>
    <pre>
cd frontend
npm install
npm run build
    </pre>

    <h3>7.2 Sync static files</h3>
    <pre>cp -r frontend/dist/* ai-agent/dashboard/static/</pre>
</div>

<!-- SECTION -->
<div class="section">
    <h2>8. Troubleshooting Upgrades</h2>

    <h3>8.1 Git pull fails</h3>
    <pre>
cd /opt/aiagent
git reset --hard
git pull
    </pre>

    <h3>8.2 Dependencies broken</h3>
    <pre>
pip3 install --upgrade pip
pip3 install -r requirements.txt --break-system-packages
    </pre>

    <h3>8.3 Service does not restart</h3>
    <pre>
systemctl status aiagent
journalctl -fu aiagent
    </pre>

    <h3>8.4 Rollback manually</h3>
    <pre>
cd /opt/aiagent/backups
sudo tar -xzf backup_YYYYMMDD.tar.gz -C /
systemctl restart aiagent
systemctl restart aiagent-worker
    </pre>

    <div class="error">
        If smoke tests fail → DO NOT continue using the new version.  
        Always rollback.
    </div>
</div>

</div>

<footer>
AI-Agent Production Documentation — Upgrade System v1 • Generated by ChatGPT (Max-Logic Mode)
</footer>

</body>
</html>

